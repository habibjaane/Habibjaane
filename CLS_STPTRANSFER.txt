USE [msajag]
GO

/****** Object:  StoredProcedure [dbo].[CLS_STPTRANSFER]    Script Date: 10/15/2025 12:41:24 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO








CREATE PROCEDURE [dbo].[CLS_STPTRANSFER]
(
 @PROVIDER VARCHAR(10),
 @USERNAME varchar(100),
 @EXCHSEG varchar(11),
 @NORMAL_INST VARCHAR(1)
)
	
/*
begin tran
EXEC CLS_STPTRANSFER '','broker'
*/
AS
BEGIN
DECLARE 
		@FROMSERVERNAME VARCHAR(100),
		@FROMDB VARCHAR(100),
		@TOSERVERNAME VARCHAR(100),
		@TODB VARCHAR(100),
		@IPADDRES VARCHAR(100),
		@MSGBOX VARCHAR(500),
		@SQL VARCHAR(8000),
		@MYRECORDS varchar(10),
		@SHAREDB VARCHAR(11)

		SELECT @SHAREDB=SHAREDB FROM MULTICOMPANY WHERE EXCHANGE +'-'+ SEGMENT = @EXCHSEG


		SELECT @FROMSERVERNAME =  FROMSERVERNAME, @FROMDB =  @SHAREDB, @TOSERVERNAME =  TOSERVERNAME, @TODB =  @SHAREDB FROM MSAJAG.dbo.CLS_INST_TYPE WHERE TYPE = 'STP' AND FLAG= @NORMAL_INST
		--select @FROMSERVERNAME,@TOSERVERNAME,@IPADDRES
		--select CAST(CONNECTIONPROPERTY('local_net_address') AS VARCHAR) 
		
		SELECT @IPADDRES = CAST(CONNECTIONPROPERTY('local_net_address') AS VARCHAR) 
		--set  @FROMSERVERNAME = @@SERVERNAME
		--set  @TOSERVERNAME = @@SERVERNAME
		--IF @PROVIDER = 'NSDL'
		--IF @PROVIDER IN ('ISO515','NSDL')
		IF @PROVIDER = 'ALL'
		BEGIN
			SET @SQL = ""
			SET @SQL = @SQL +  "DELETE FROM [" + @TOSERVERNAME + "].MSAJAG.DBO.STP_HEADER_NEW WHERE CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112) "
			SET @SQL = @SQL + " INSERT INTO [" + @TOSERVERNAME + "].MSAJAG.DBO.STP_HEADER_NEW "
			SET @SQL = @SQL + " Select * from MSAJAG.DBO.Stp_Header_New Where  CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112)"
			SET @SQL = @SQL +  "DELETE FROM MSAJAG.DBO.STP_HEADER_NEW WHERE CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112) "
			EXEC(@SQL)
		print(@SQL) 	
		END
		ELSE
		BEGIN
			SET @SQL = ""
			SET @SQL = @SQL + "  DELETE FROM  [" + @TOSERVERNAME +"]." + ISNULL(@SHAREDB,'') + ".DBO.Stp_Header_New WHERE SERVICEPROVIDER = '" + @PROVIDER + "' AND CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112) "
			SET @SQL = @SQL + " INSERT INTO [" + @TOSERVERNAME +"]." + ISNULL(@SHAREDB,'') + ".DBO.Stp_Header_New "
			SET @SQL = @SQL + " Select * from " + ISNULL(@SHAREDB,'') + ".DBO.Stp_Header_New Where ServiceProvider = '" + @PROVIDER + "' AND CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112) "
			SET @SQL = @SQL + "  DELETE FROM " + ISNULL(@SHAREDB,'') + ".DBO.Stp_Header_New WHERE SERVICEPROVIDER = '" + @PROVIDER + "' AND CREATIONDATE = CONVERT(VARCHAR,GETDATE(),112) "	
			EXEC(@SQL)
			print(@SQL) 
		END
		SET @MSGBOX = 'Transfer Completed Successfully'


	--SELECT @MSGBOX as ERROR,@FROMSERVERNAME AS FROMSERVER ,@TOSERVERNAME AS TOSERVER,@TODB AS TODB
END
--go
--exec  CLS_STPTRANSFER 'ISO515',	'DEmo','NSE-CAPITAL','N'
--exec cls_datatransfer @USERNAME='DEmo',@PARTYCODE='',@NORMAL_INST='N',@FETCH='Fetch',@MODULE='STP',@PROVIDER='',@SAUDADATE='',@EXCHSEG='NSE-CAPITAL'


GO


